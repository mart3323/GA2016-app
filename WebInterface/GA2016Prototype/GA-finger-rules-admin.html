<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">

<dom-module id="GA-finger-rules-admin">

    <style is="custom-style">
        #console .out { color: blue; }
        #console .in { color: green; }

        #flags td {
            padding: 8px;
        }
        #fingers td {
            height:48px;
            padding:8px;
        }
        paper-icon-button {
            --iron-icon-height: 48px;
            --iron-icon-width: 48px;
        }
        paper-icon-button.active {
            color:green !important;
        }
        #console {
            white-space: pre;
            height: 256px;
            border:1px solid black;
            margin: 8px;
            overflow: auto;
        }

    </style>

    <script src="../extjs/jquery.js"></script>
    <script src="../extjs/socket.io.js"></script>
    <script src="../../nodejs/js/encryption.js"></script>
    <script src="../../nodejs/js/Fingers.js"></script>

    <template>
        <span id="connected"></span>
        <h3>Admin panel (should see everyone's fingers)</h3>
        <table id="flags">
            <tr>
                <td>Active: <span>[[fingers.unused_flags.active]]</span></td>
                <td>Queue: <span>[[fingers.unused_flags.queue]]</span></td>
            </tr>
        </table>
        <table id="fingers">
            <tr>
                <td>
                    <paper-icon-button icon="clear" on-tap="clear_1"></paper-icon-button>
                    <br/>
                    Clear
                </td>
                <template is="dom-repeat" items="[[fingers_array(fingers)]]" filter="[[filter_fingers_of_type(1)]]">
                    <td>
                        <paper-icon-button on-tap="activate" icon="GA:circled-1" finger_id="[[item.id]]" class$="[[item.state]]"></paper-icon-button>
                        <br/>
                        <span>[[item.owner]]</span>
                    </td>
                </template>
            </tr>
            <tr>
                <td>
                    <paper-icon-button icon="clear" on-tap="clear_2"></paper-icon-button>
                    <br/>
                    Clear
                </td>
                <template is="dom-repeat" items="[[fingers_array(fingers)]]" filter="[[filter_fingers_of_type(2)]]">
                    <td>
                        <paper-icon-button on-tap="activate" icon="GA:circled-2" finger_id="[[item.id]]" class$="[[item.state]]"></paper-icon-button>
                        <br/>
                        <span>[[item.owner]]</span>
                    </td>
                </template>
            </tr>
            <tr>
                <td>
                    <paper-icon-button icon="clear" on-tap="clear_3"></paper-icon-button>
                    <br/>
                    Clear
                </td>
                <template is="dom-repeat" items="[[fingers_array(fingers)]]" filter="[[filter_fingers_of_type(3)]]">
                    <td>
                        <paper-icon-button on-tap="activate" icon="GA:circled-3" finger_id="[[item.id]]" class$="[[item.state]]"></paper-icon-button>
                        <br/>
                        <span>[[item.owner]]</span>
                    </td>
                </template>
            </tr>
            <tr>
                <td></td> <td></td> <td></td>
            </tr>
        </table>
        <div id="console"></div>
    </template>

    <script>
        "use strict";

        var IP = "mart3323-laptop-lm";
        var PORT = 7332;
        var private_key = "test".split(" ").join("");
        var public_key = "ificate".split(" ").join("");


        function injectDebug(socket){
            var encryption = new Encryption(private_key, public_key);
            var $console = $(this.$.console);
            console.log("Debug applied to");
            console.log($console);
            var temp_on = socket.on;
            socket.when = function(type, func){
                temp_on.apply(socket, [type, function(msg){
                    var element = $("<div>").addClass("out").hide().text("  → "+type+" "+JSON.stringify(msg)).css("color","blue").fadeIn();
                    $console.prepend(element);
                    element.animate({ opacity: 0.25}, 5000);
                    func(msg);
                }]);
            }.bind(socket);

            var temp_emit = socket.emit;
            socket.send = function(type,msg){
                var element = $("<div>").addClass("in").hide().text(" ←  "+type+" "+JSON.stringify(msg)).css("color","green").fadeIn();
                $console.prepend(element);
                element.animate({ opacity: 0.25}, 5000);
                temp_emit.apply(socket, [type, msg]);
            }.bind(socket);
        }


        Polymer({
            is:"GA-finger-rules-admin",

            getKeys : function(o){
                return Object.keys(o);
            },

            properties: {
                test: {value: {1:1, 2:2, 21:21}},
                fingers: {
                    type:Fingers,
                    value: new Fingers()
                },
                connected: {value:false}
            },

            ready: function(){
                new Promise(function(resolve, reject){
                    var socket = io(IP+":"+PORT, {reconnection:false});
                    injectDebug.apply(this, [socket]);
                    socket.when("error", function(){reject("Failed to connect");});
                    socket.when("connect_error", function(){reject("Failed to connect");});
                    socket.when("Challenge", function(message){
                        socket.send("Register", {name:"SPEAKER", message:message});
                    });
                    $("#connected").text("Connecting...");
                    socket.when("Registered",function(isSuccess){
                        if(isSuccess){
                            this.connected = true;
                            resolve(socket);
                        } else {
                            this.connected = false;
                            $("#connected").text("Failed");
                            reject("Server did not accept signature");
                        }
                    }.bind(this));
                    socket.connect();
                }.bind(this))
                        .then(function(socket){
                            this.socket = socket;
                            socket.when("FingerUpdate", this.UpdateFingers.bind(this));
                        }.bind(this))
                        .catch(function(e){console.warn(e);});

            },

            clear_1: function(){
                this.clear(1);
            },
            clear_2: function(){
                this.clear(2);
            },
            clear_3: function(){
                this.clear(3);
            },
            clear: function(n){
                this.socket.send("ClearFingers", n);
            },
            fingers_array: function(fingers){
                return this.fingers.as_array();
            },
            filter_fingers_of_type: function(n){
                return function(finger){
                    return finger.type == n;
                }
            },
            UpdateFingers: function(fingers){
                this.fingers = new Fingers(fingers);
                this.notify();
            },
            finger: function(n){
                if(n == 1 || n == 2 || n == 3){
                    this.socket.send("Finger", n);
                }
            },
            activate: function(e){
                var local_target = Polymer.dom(e).localTarget;
                var id = local_target.finger_id;

                this.socket.send("ActivateFinger", id);
            },
            notify: function(){
                var temp = this.fingers;
                this.set("fingers",new Fingers());
                this.set("fingers",temp);
            }
        })
    </script>
</dom-module>
