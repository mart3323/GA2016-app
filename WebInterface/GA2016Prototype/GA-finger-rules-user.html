<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="bower_components/paper-input/paper-input.html">

<dom-module id="GA-finger-rules-user">

    <style is="custom-style">
        #console .out { color: blue; }
        #console .in { color: green; }

        #fingers td {
            color: blue;
        }
        paper-icon-button {
            --iron-icon-height: 48px;
            --iron-icon-width: 48px;
        }
        paper-icon-button.active {
            color:green !important;
        }
        #console {
            white-space: pre;
            height: 256px;
            border:1px solid black;
            margin: 8px;
            overflow: auto;
        }

    </style>

    <script src="../extjs/jquery.js"></script>
    <script src="../extjs/socket.io.js"></script>
    <script src="../../nodejs/js/Fingers.js"></script>

    <template>
        <div id="form">
            <span id="connected"></span>
            <paper-input id="name" placeholder="name"></paper-input>
            <paper-button on-tap="startServer" style="width:300px;">Connect</paper-button>
        </div>
        <div id="controls" style="display:none;">
            <template is="dom-repeat" items="[[fingers.types]]" as="ft">
                <paper-icon-button disabled="[[!connected]]" icon="[[finger_to_icon(ft)]]" on-tap="_finger" arg="[[ft]]"></paper-icon-button>
            </template>

            <table id="fingers">
                <template is="dom-repeat" items="[[fingers.types]]" as="ft">
                    <tr>
                        <template is="dom-repeat" items="[[fingers_array(fingers)]]" as="f" filter="[[filter_fingers_of_type(ft)]]">
                            <td>
                                <paper-icon-button on-tap="on_redact" icon="[[finger_to_icon(ft)]]" finger_id="[[f.id]]" class$="[[f.state]]"></paper-icon-button>
                            </td>
                        </template>
                    </tr>
                </template>
            </table>
            <div id="console"></div>
            <div style="display:none;">
                <content id="content" select="*"></content>
            </div>
        </div>
    </template>

    <script>
        "use strict";

        var IP = "localhost";
        var PORT = 7332;
        var private_key = "-----BEGIN RSA PRIVATE KEY-----\
            MIIBOwIBAAJBAJgC6p1FA2OcaoI2kqg0pPZouWy3ehQ1KZNvhpzm+9hfQNynop1y\
            Mck1dQ4KPBMG67qvYuHitX/YB3/EMiR1c1UCAwEAAQJAbwmyVy8SSrD3HCbA+h16\
            YoQc7k0X36r1s7zDl9kiHepSPsM9ZFOJxT+YgKGk3Rn9EiP8iEdFoPXtKsfswj1g\
            AQIhAOkX7OtTE0dPGa7QV5qhxwRBQEYe2oHaGsBfUbZux2h9AiEApvMo8JOFV9z3\
            rfC5RmliVMHQO1PIIJvWh0tJSa/6hbkCIAZuMosLb6y38e1wsfoCHItxgWRt1Xlf\
            mv1To910kOvBAiEAjEniih58u3N8UZbqKafesDhZIbFqhzRM1k3GXPxauUkCIQDQ\
            lSMNQAIOItXMISpAAck5+e46rf0RGEPD8dQOqVn7Lg==\
            -----END RSA PRIVATE KEY-----".split(" ").join("");
        var public_key = "-----BEGIN PUBLIC KEY-----\
            MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAJgC6p1FA2OcaoI2kqg0pPZouWy3ehQ1\
            KZNvhpzm+9hfQNynop1yMck1dQ4KPBMG67qvYuHitX/YB3/EMiR1c1UCAwEAAQ==\
            -----END PUBLIC KEY-----".split(" ").join("");


        function injectDebug(socket){
            var $console = $(this.$.console);
            console.log("Debug applied to");
            console.log($console);
            var temp_on = socket.on;
            socket.when = function(type, func){
                temp_on.apply(socket, [type, function(msg){
                    var element = $("<div>").addClass("out").hide().text("  → "+type+" "+JSON.stringify(msg)).css("color","blue").fadeIn();
                    $console.prepend(element);
                    element.animate({ opacity: 0.25}, 5000);
                    func(msg);
                }]);
            }.bind(socket);

            var temp_emit = socket.emit;
            socket.send = function(type,msg){
                var element = $("<div>").addClass("in").hide().text(" ←  "+type+" "+JSON.stringify(msg)).css("color","green").fadeIn();
                $console.prepend(element);
                element.animate({ opacity: 0.25}, 5000);
                temp_emit.apply(socket, [type, msg]);
            }.bind(socket);
        }


        Polymer({
            is:"GA-finger-rules-user",

            properties: {
                test: {value: {1:1, 2:2, 21:21}},
                fingers: {
                    type: Fingers,
                    value: new Fingers()
                },
                connected: {value:false},
                started: {value: false}
            },

            finger_to_icon: function (f){
                return "GA:finger-"+f;
            },
            startServer: function(){
                if(this.started) return;
                $(this.$.form).hide();
                $(this.$.controls).show();
                var name = this.$.name.value;

                new Promise(function(resolve, reject){
                    var socket = io(IP+":"+PORT, {reconnection:false});
                    injectDebug.apply(this, [socket]);
                    socket.when("error", function(){reject("Failed to connect");});
                    socket.when("connect_error", function(){reject("Failed to connect");});
                    socket.when("Challenge", function(message){
                        socket.send("Register", {name:name, message:message});
                    });
                    $("#connected").text("Connecting...");
                    socket.when("Registered",function(isSuccess){
                        if(isSuccess){
                            this.connected = true;
                            resolve(socket);
                        } else {
                            this.connected = false;
                            $("#connected").text("Failed");
                            reject("Server did not accept signature");
                        }
                    }.bind(this));
                    socket.connect();
                }.bind(this))
                .then(function(socket){
                    this.socket = socket;
                    socket.when("FingerUpdate", this.UpdateFingers.bind(this));
                }.bind(this))
                .catch(function(e){console.warn(e);});
            },
            fingers_array: function(fingers){
                return this.fingers.as_array();
            },
            filter_fingers_of_type: function(n){
                return function(finger){
                    return finger.type == n;
                }
            },
            UpdateFingers: function(fingers){
                this.fingers = new Fingers(fingers);
                this.notify();
            },
            _finger: function(e){
                this.finger(e.currentTarget.arg);
            },
            finger: function(n){
                this.socket.send("Finger", n);
            },
            on_redact: function(e){
                var local_target = Polymer.dom(e).localTarget;
                var id = local_target.finger_id;
                this.fingers.get_finger(id).state = "redacting";
                this.notify();

                this.socket.send("RedactFinger", id);
            },
            notify: function(){
                var temp = this.fingers;
                this.set("fingers",new Fingers());
                this.set("fingers",temp);
            }
        })
    </script>
</dom-module>
