<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title></title>
        <script src="extjs/jquery.js"></script>
        <script src="extjs/socket.io.js"></script>
        <script src="js/External/RSA.js"></script>
        <script src="js/encryption.js"></script>
        <script>
            $(document).ready(function(){
                var private_key = "-----BEGIN RSA PRIVATE KEY-----\
                MIIBOwIBAAJBAJgC6p1FA2OcaoI2kqg0pPZouWy3ehQ1KZNvhpzm+9hfQNynop1y\
                Mck1dQ4KPBMG67qvYuHitX/YB3/EMiR1c1UCAwEAAQJAbwmyVy8SSrD3HCbA+h16\
                YoQc7k0X36r1s7zDl9kiHepSPsM9ZFOJxT+YgKGk3Rn9EiP8iEdFoPXtKsfswj1g\
                AQIhAOkX7OtTE0dPGa7QV5qhxwRBQEYe2oHaGsBfUbZux2h9AiEApvMo8JOFV9z3\
                rfC5RmliVMHQO1PIIJvWh0tJSa/6hbkCIAZuMosLb6y38e1wsfoCHItxgWRt1Xlf\
                mv1To910kOvBAiEAjEniih58u3N8UZbqKafesDhZIbFqhzRM1k3GXPxauUkCIQDQ\
                lSMNQAIOItXMISpAAck5+e46rf0RGEPD8dQOqVn7Lg==\
                -----END RSA PRIVATE KEY-----";
                var public_key = "-----BEGIN PUBLIC KEY-----\
                MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAJgC6p1FA2OcaoI2kqg0pPZouWy3ehQ1\
                KZNvhpzm+9hfQNynop1yMck1dQ4KPBMG67qvYuHitX/YB3/EMiR1c1UCAwEAAQ==\
                -----END PUBLIC KEY-----";

                connect_to_server("localhost", 7332, private_key, public_key)
                    .then(serve)
                    .catch(function(e){console.warn(e);});

                var server_events = {
                    RegisterFinger: $.Callbacks(),
                    RedactedFinger: $.Callbacks(),
                };
                var user_events = {
                    Finger: $.Callbacks(),
                    Redact: $.Callbacks(),
                };
                $("#f1").click(function(){ user_events.Finger.fire(1); });
                $("#f2").click(function(){ user_events.Finger.fire(2); });
                $("#f3").click(function(){ user_events.Finger.fire(3); });

                server_events.RegisterFinger.add(function(finger){
                    var type = finger.type;
                    var id = finger.id;
                    $("#fingerCounts").find("td").eq(type-1).append(
                        $("<span></span>").addClass("finger").text(id).attr("finger_id",id).click(user_events.Redact.fire.bind(this,finger.id))
                    )
                });
                server_events.RedactedFinger.add(function(id){
                    $("span[finger_id="+id+"]").remove();
                });

                function injectDebug(socket){
                    var encryption = new Encryption(private_key, public_key);
                    var $console = $("#console");
                    var temp_on = socket.on;
                    socket.when = function(type, func){
                        temp_on.apply(socket, [type, function(msg){
                            $console.prepend($("<div>").addClass("out").hide().text("  → "+type+" "+JSON.stringify(msg)).fadeIn());
                            func(msg);
                        }]);
                    }.bind(socket);

                    var temp_emit = socket.emit;
                    socket.send = function(type,msg){
                        $console.prepend($("<div>").addClass("in").hide().text(" ←  "+type+" "+JSON.stringify(msg)).fadeIn());
                        temp_emit.apply(socket, [type, encryption.encrypt(msg)]);
                    }.bind(socket);
                }

                function connect_to_server(IP, PORT, private_key, public_key){
                    return new Promise(function(resolve, reject){
                        var socket = io(IP+":"+PORT, {reconnection:false});
                        injectDebug(socket);
                        socket.when("error", function(){reject("Failed to connect");});
                        socket.when("connect_error", function(){reject("Failed to connect");});
                        socket.when("Challenge", function(message){
                            socket.send("Register", message);
                        });
                        socket.when("Registered",function(isSuccess){
                            if(isSuccess){
                                resolve(socket);
                            } else {
                                reject("Server did not accept signature");
                            }
                        });
                        socket.connect();
                    });
                }

                function serve(socket){
                    user_events.Finger.add(function(n){
                        if(n == 1 || n == 2 || n == 3){
                            socket.send("Finger", n);
                        }
                    });
                    user_events.Redact.add(function(id){
                        socket.send("RedactFinger", id);
                    });

                    socket.when("RegisterFinger", server_events.RegisterFinger.fire);
                    socket.when("RedactedFinger", server_events.RedactedFinger.fire);
                }

            });
        </script>
        <style>
            #console .out { color: blue; }
            #console .in { color: green; }
            #fingerCounts .finger { border: 1px solid black; margin:2px; }

            #console {
                white-space: pre;
            }
        </style>
    </head>
    <body>
        <span id="connected">connected</span>

        <table>
            <tr>
                <td id="f1">Finger1</td> <td id="f2">Finger2</td> <td id="f3">Finger3</td>
            </tr>
            <tr id="fingerCounts">
                <td></td> <td></td> <td></td>
            </tr>
            <tr>
                <td></td> <td></td> <td></td>
            </tr>
        </table>
        <div id="console"></div>

    </body>
</html>
