<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title></title>
        <script src="extjs/jquery.js"></script>
        <script src="extjs/socket.io.js"></script>
        <script src="js/config.js"></script>
        <script src="js/socketClient.js"></script>
        <script src="js/encryption.js"></script>
        <script>
            //TODO: Configure router to redirect "ga2016" to a specific machine
            var Connection = function(){
                this.broadcast_via_LAN = function(message){
                    return null;
                };
                this.send = function(message){
                    return {to:function(ip){
                        return null;
                    }}
                };
                this.onReceiveBroadcast = function(){};
                this.onReceiveDirectMessage = function(){};
            };
            var ClientConnection = function(client_encryption, server_encryption_public_key_only, connection){
                this.onConnect = $.Callbacks();
                this.onDisconnect = $.Callbacks();

                this.registered = false;
                connection.listenFor("registration approved");

                connection.onConnect.add(function(){
                    this.onConnect.fire();
                    if(!this.registered){
                        this.register();
                    }
                }.bind(this));

                connection.onDisconnect.add(function(){
                    this.onDisconnect.fire();
                    this.registered = false;
                }.bind(this));

                connection.onMessage.add(function(type, msg){
                    if(type == "registration approved"){
                        this.registered = true;
                        console.log("Registration approved");
                    }
                }.bind(this));

                this.register = function(){
                    connection.send("register", {
                        name: client_encryption.public_key,
                        signature: client_encryption.sign(client_encryption.public_key)
                    });
                }.bind(this);

                this.send_message_to_server = function(message){
                    //TODO: send message to server, signed
                };
                this.send_message = function(message){
                    return connection.send(message)
                };
            };

            $(document).ready(function(){
                var client_encryption = new Encryption("client1secretkey", "client1publickey");
                var server_encryption = new Encryption(undefined, "server1publickey");
                var socket = new SocketClient(MESSAGING_SERVER_IP, MESSAGING_SERVER_PORT);
                var connection = new ClientConnection(client_encryption, server_encryption, socket);

                $("#connected").css("background-color",socket.isConnected() ? "lime" : "salmon");
                socket.onConnect.add(function(){
                    $("#connected").css("background-color","lime");
                });
                socket.onDisconnect.add(function(){
                    $("#connected").css("background-color","salmon");
                });
            });
        </script>
        <script>
        </script>
    </head>
    <body>
        <span id="connected">connected</span>
        <table>
            <tr>
                <td id="b1"></td>
                <td id="b2"></td>
                <td id="b3"></td>
            </tr>
            <tr>
                <td id="b4"></td>
                <td id="b5"></td>
                <td id="b6"></td>
            </tr>
            <tr>
                <td id="b7"></td>
                <td id="b8"></td>
                <td id="b9"></td>
            </tr>
        </table>

    </body>
</html>